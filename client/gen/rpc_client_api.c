/*
 * AUTO-GENERATED FILE. DO NOT EDIT.
 * Generated by: tools/gen_rpc_client_api.py
 */

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <inttypes.h>
#include <stdint.h>
#include <stdbool.h>

#include "cJSON.h"
#include "rpc_client.h"
#include "rpc_client_api.h"

static uint32_t g_rpc_request_id = 1;

static char* rpc_strdup(const char* s)
{
    if (s == NULL) {
        return NULL;
    }
    size_t n = strlen(s);
    char* out = (char*)malloc(n + 1);
    if (out == NULL) {
        return NULL;
    }
    memcpy(out, s, n + 1);
    return out;
}

// 构造 JSON-RPC 2.0 请求字符串：{jsonrpc, method, params, id}。
// 返回堆上分配的字符串，调用者需要 free()。
static char* rpc_build_request(const char* method, cJSON* params)
{
    cJSON* root = cJSON_CreateObject();
    if (root == NULL) {
        return NULL;
    }
    if (cJSON_AddStringToObject(root, "jsonrpc", "2.0") == NULL) {
        cJSON_Delete(root);
        return NULL;
    }
    if (cJSON_AddStringToObject(root, "method", method) == NULL) {
        cJSON_Delete(root);
        return NULL;
    }
    if (params != NULL) {
        cJSON_AddItemToObject(root, "params", params);
    }
    cJSON_AddNumberToObject(root, "id", (double)g_rpc_request_id++);

    char* out = cJSON_PrintUnformatted(root);
    cJSON_Delete(root);
    return out;
}

// 解析 JSON 字符串为 cJSON 对象。
// 返回 cJSON*，调用者需要使用 cJSON_Delete() 释放。
static cJSON* rpc_parse_response(const char* json)
{
    if (json == NULL) {
        return NULL;
    }
    return cJSON_Parse(json);
}

// Return a simple string for connectivity test
char* ping()
{
    cJSON* params = cJSON_CreateObject();
    if (params == NULL) {
        return NULL;
    }
    char* req = rpc_build_request("ping", params);
    if (req == NULL) {
        cJSON_Delete(params);
        return NULL;
    }
    char* resp_json = rpc_client_call(req);
    free(req);
    if (resp_json == NULL) {
        return NULL;
    }

    cJSON* root = rpc_parse_response(resp_json);
    free(resp_json);
    if (root == NULL) {
        return NULL;
    }

    cJSON* err = cJSON_GetObjectItemCaseSensitive(root, "error");
    if (err != NULL) {
        cJSON_Delete(root);
        return NULL;
    }

    cJSON* result = cJSON_GetObjectItemCaseSensitive(root, "result");
    if (result == NULL) {
        cJSON_Delete(root);
        return NULL;
    }
    if (!cJSON_IsString(result) || result->valuestring == NULL) {
        cJSON_Delete(root);
        return NULL;
    }
    char* v = rpc_strdup(result->valuestring);
    cJSON_Delete(root);
    return v;
}

// Echo back x (i64)
int64_t echo_i64(int64_t x)
{
    cJSON* params = cJSON_CreateObject();
    if (params == NULL) {
        return 0;
    }
    {
        char buf_x[32];
        snprintf(buf_x, sizeof(buf_x), "%" PRId64, (int64_t)x);
        cJSON_AddStringToObject(params, "x", buf_x);
    }
    char* req = rpc_build_request("echo_i64", params);
    if (req == NULL) {
        cJSON_Delete(params);
        return 0;
    }
    char* resp_json = rpc_client_call(req);
    free(req);
    if (resp_json == NULL) {
        return 0;
    }

    cJSON* root = rpc_parse_response(resp_json);
    free(resp_json);
    if (root == NULL) {
        return 0;
    }

    cJSON* err = cJSON_GetObjectItemCaseSensitive(root, "error");
    if (err != NULL) {
        cJSON_Delete(root);
        return 0;
    }

    cJSON* result = cJSON_GetObjectItemCaseSensitive(root, "result");
    if (result == NULL) {
        cJSON_Delete(root);
        return 0;
    }
    int64_t v = 0;
    if (cJSON_IsString(result) && result->valuestring != NULL) {
        char* endptr = NULL;
        long long tmp = strtoll(result->valuestring, &endptr, 10);
        if (endptr == result->valuestring || *endptr != '\0') {
            cJSON_Delete(root);
            return 0;
        }
        v = (int64_t)tmp;
    } else if (cJSON_IsNumber(result)) {
        v = (int64_t)result->valuedouble;
    } else {
        cJSON_Delete(root);
        return 0;
    }
    cJSON_Delete(root);
    return v;
}

// Return a + b (i32)
int32_t add_i32(int32_t a, int32_t b)
{
    cJSON* params = cJSON_CreateObject();
    if (params == NULL) {
        return 0;
    }
    cJSON_AddNumberToObject(params, "a", (double)a);
    cJSON_AddNumberToObject(params, "b", (double)b);
    char* req = rpc_build_request("add_i32", params);
    if (req == NULL) {
        cJSON_Delete(params);
        return 0;
    }
    char* resp_json = rpc_client_call(req);
    free(req);
    if (resp_json == NULL) {
        return 0;
    }

    cJSON* root = rpc_parse_response(resp_json);
    free(resp_json);
    if (root == NULL) {
        return 0;
    }

    cJSON* err = cJSON_GetObjectItemCaseSensitive(root, "error");
    if (err != NULL) {
        cJSON_Delete(root);
        return 0;
    }

    cJSON* result = cJSON_GetObjectItemCaseSensitive(root, "result");
    if (result == NULL) {
        cJSON_Delete(root);
        return 0;
    }
    if (!cJSON_IsNumber(result)) {
        cJSON_Delete(root);
        return 0;
    }
    int32_t v = (int32_t)result->valuedouble;
    cJSON_Delete(root);
    return v;
}

// Return a * b (double)
double mul_double(double a, double b)
{
    cJSON* params = cJSON_CreateObject();
    if (params == NULL) {
        return 0.0;
    }
    cJSON_AddNumberToObject(params, "a", (double)a);
    cJSON_AddNumberToObject(params, "b", (double)b);
    char* req = rpc_build_request("mul_double", params);
    if (req == NULL) {
        cJSON_Delete(params);
        return 0.0;
    }
    char* resp_json = rpc_client_call(req);
    free(req);
    if (resp_json == NULL) {
        return 0.0;
    }

    cJSON* root = rpc_parse_response(resp_json);
    free(resp_json);
    if (root == NULL) {
        return 0.0;
    }

    cJSON* err = cJSON_GetObjectItemCaseSensitive(root, "error");
    if (err != NULL) {
        cJSON_Delete(root);
        return 0.0;
    }

    cJSON* result = cJSON_GetObjectItemCaseSensitive(root, "result");
    if (result == NULL) {
        cJSON_Delete(root);
        return 0.0;
    }
    if (!cJSON_IsNumber(result)) {
        cJSON_Delete(root);
        return 0.0;
    }
    double v = (double)result->valuedouble;
    cJSON_Delete(root);
    return v;
}

// Return true if n is even
bool is_even(int32_t n)
{
    cJSON* params = cJSON_CreateObject();
    if (params == NULL) {
        return 0;
    }
    cJSON_AddNumberToObject(params, "n", (double)n);
    char* req = rpc_build_request("is_even", params);
    if (req == NULL) {
        cJSON_Delete(params);
        return 0;
    }
    char* resp_json = rpc_client_call(req);
    free(req);
    if (resp_json == NULL) {
        return 0;
    }

    cJSON* root = rpc_parse_response(resp_json);
    free(resp_json);
    if (root == NULL) {
        return 0;
    }

    cJSON* err = cJSON_GetObjectItemCaseSensitive(root, "error");
    if (err != NULL) {
        cJSON_Delete(root);
        return 0;
    }

    cJSON* result = cJSON_GetObjectItemCaseSensitive(root, "result");
    if (result == NULL) {
        cJSON_Delete(root);
        return 0;
    }
    if (!cJSON_IsBool(result)) {
        cJSON_Delete(root);
        return 0;
    }
    bool v = (result->type & cJSON_True) != 0;
    cJSON_Delete(root);
    return v;
}

// Return length of s (bytes)
int32_t strlen_s(const char* s)
{
    cJSON* params = cJSON_CreateObject();
    if (params == NULL) {
        return 0;
    }
    cJSON_AddStringToObject(params, "s", s);
    char* req = rpc_build_request("strlen_s", params);
    if (req == NULL) {
        cJSON_Delete(params);
        return 0;
    }
    char* resp_json = rpc_client_call(req);
    free(req);
    if (resp_json == NULL) {
        return 0;
    }

    cJSON* root = rpc_parse_response(resp_json);
    free(resp_json);
    if (root == NULL) {
        return 0;
    }

    cJSON* err = cJSON_GetObjectItemCaseSensitive(root, "error");
    if (err != NULL) {
        cJSON_Delete(root);
        return 0;
    }

    cJSON* result = cJSON_GetObjectItemCaseSensitive(root, "result");
    if (result == NULL) {
        cJSON_Delete(root);
        return 0;
    }
    if (!cJSON_IsNumber(result)) {
        cJSON_Delete(root);
        return 0;
    }
    int32_t v = (int32_t)result->valuedouble;
    cJSON_Delete(root);
    return v;
}

// Return a formatted string mixing i32/double/bool
char* mix3(int32_t a, double b, bool ok)
{
    cJSON* params = cJSON_CreateObject();
    if (params == NULL) {
        return NULL;
    }
    cJSON_AddNumberToObject(params, "a", (double)a);
    cJSON_AddNumberToObject(params, "b", (double)b);
    cJSON_AddBoolToObject(params, "ok", ok);
    char* req = rpc_build_request("mix3", params);
    if (req == NULL) {
        cJSON_Delete(params);
        return NULL;
    }
    char* resp_json = rpc_client_call(req);
    free(req);
    if (resp_json == NULL) {
        return NULL;
    }

    cJSON* root = rpc_parse_response(resp_json);
    free(resp_json);
    if (root == NULL) {
        return NULL;
    }

    cJSON* err = cJSON_GetObjectItemCaseSensitive(root, "error");
    if (err != NULL) {
        cJSON_Delete(root);
        return NULL;
    }

    cJSON* result = cJSON_GetObjectItemCaseSensitive(root, "result");
    if (result == NULL) {
        cJSON_Delete(root);
        return NULL;
    }
    if (!cJSON_IsString(result) || result->valuestring == NULL) {
        cJSON_Delete(root);
        return NULL;
    }
    char* v = rpc_strdup(result->valuestring);
    cJSON_Delete(root);
    return v;
}
